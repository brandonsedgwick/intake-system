// Prisma Schema for Therapy Intake System
// Migrating configuration data from Google Sheets to SQLite

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// Clinicians - Staff who provide therapy
// ============================================
model Clinician {
  id                   String   @id @default(uuid())
  firstName            String
  lastName             String
  email                String   @unique
  calendarId           String?
  simplePracticeId     String?
  insurancePanels      String   @default("[]") // JSON array of strings
  specialties          String   @default("[]") // JSON array of strings
  newClientCapacity    Int      @default(0)
  isAcceptingNew       Boolean  @default(true)
  defaultSessionLength Int      @default(50)

  // Relations
  availabilitySlots Availability[]

  @@map("clinicians")
}

// ============================================
// Availability - Clinician scheduling slots
// ============================================
model Availability {
  id             String  @id @default(uuid())
  clinicianId    String
  dayOfWeek      Int // 0-6 (Sunday-Saturday)
  startTime      String // HH:MM format
  endTime        String // HH:MM format
  isRecurring    Boolean @default(true)
  specificDate   String? // ISO date for non-recurring
  isBooked       Boolean @default(false)
  bookedClientId String? // References Client in Google Sheets

  // Relations
  clinician Clinician @relation(fields: [clinicianId], references: [id], onDelete: Cascade)

  @@index([clinicianId])
  @@index([dayOfWeek])
  @@map("availability")
}

// ============================================
// Template Sections - Custom categories for organizing templates
// ============================================
model TemplateSection {
  id        String   @id @default(uuid())
  name      String
  order     Int      @default(0)
  color     String?  // Optional: blue, green, purple, amber, red
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  templates EmailTemplate[]

  @@index([order])
  @@map("template_sections")
}

// ============================================
// Email Templates - Reusable email content
// ============================================
model EmailTemplate {
  id         String   @id @default(uuid())
  name       String
  type       String   // initial_outreach, follow_up_1, follow_up_2, referral_*
  subject    String
  body       String   // HTML or text content (can be long)
  bodyFormat String   @default("html") // "html" | "plain"
  isActive   Boolean  @default(false)
  isDefault  Boolean  @default(false) // Default template for this type
  sectionId  String?  // Optional section assignment
  order      Int      @default(0)     // Order within section
  updatedAt  DateTime @default(now()) @updatedAt
  updatedBy  String?

  section TemplateSection? @relation(fields: [sectionId], references: [id], onDelete: SetNull)

  @@index([type, isDefault])
  @@index([sectionId, order])
  @@map("email_templates")
}

// ============================================
// Audit Log - Track all system changes
// ============================================
model AuditLog {
  id            String   @id @default(uuid())
  timestamp     DateTime @default(now())
  userId        String
  userEmail     String
  action        String // create, update, delete, etc.
  entityType    String // client, clinician, template, settings, communication
  entityId      String
  previousValue String? // JSON string of previous state
  newValue      String? // JSON string of new state
  ipAddress     String?

  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([userEmail])
  @@map("audit_log")
}

// ============================================
// Evaluation Criteria - Rules for client evaluation
// ============================================
model EvaluationCriteria {
  id          String   @id @default(uuid())
  name        String
  description String?
  field       String // Client field to evaluate
  operator    String // exists, not_exists, equals, contains, etc.
  value       String // Comparison value (comma-separated for lists)
  action      String // flag, flag_urgent, flag_review
  priority    Int      @default(0) // Lower = higher priority
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@index([isActive, priority])
  @@map("evaluation_criteria")
}

// ============================================
// Text Evaluation Rules - Pattern matching for intake forms
// ============================================
model TextEvaluationRule {
  id             String   @id @default(uuid())
  name           String
  category       String // suicidal_ideation, self_harm, substance_use, etc.
  severity       String // none, low, medium, high, urgent
  patterns       String   @default("[]") // JSON array of pattern strings
  isRegex        Boolean  @default(false)
  negationWords  String   @default("[]") // JSON array of negation words
  negationWindow Int      @default(5)
  requiresLLM    Boolean  @default(false)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  @@index([isActive])
  @@index([category])
  @@map("text_evaluation_rules")
}

// ============================================
// Referral Clinics - External clinics for referrals
// ============================================
model ReferralClinic {
  id           String   @id @default(uuid())
  practiceName String
  address      String?
  phone        String?
  email        String?
  specialties  String   @default("[]") // JSON array of specialties
  notes        String?
  customFields String? // JSON object for dynamic fields
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  @@index([isActive])
  @@map("referral_clinics")
}

// ============================================
// Referral Clinics Config - Custom field definitions
// ============================================
model ReferralClinicsConfig {
  id           String   @id @default(uuid())
  customFields String   @default("[]") // JSON array of custom field definitions
  updatedAt    DateTime @default(now()) @updatedAt

  @@map("referral_clinics_config")
}

// ============================================
// Settings - Key-value application settings
// ============================================
model Setting {
  key       String   @id
  value     String
  updatedAt DateTime @default(now()) @updatedAt

  @@map("settings")
}

// ============================================
// Intake Fields - Form field configuration
// ============================================
model IntakeField {
  id              String   @id @default(uuid())
  field           String   @unique // Client field name
  label           String
  description     String?
  type            String // text, email, phone, date, select, multiselect, textarea, checkbox
  googleFormField String? // Field name in Google Form (for mapping)
  isRequired      Boolean  @default(false)
  isActive        Boolean  @default(true)
  order           Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  @@index([isActive, order])
  @@map("intake_fields")
}

// ============================================
// Communications - Email/phone/note records
// (Linked to Clients via clientId stored as string)
// ============================================
model Communication {
  id                    String   @id @default(uuid())
  clientId              String // References Client in Google Sheets
  timestamp             DateTime @default(now())
  direction             String // in, out
  type                  String // email, note, phone
  gmailMessageId        String?
  gmailThreadId         String?
  subject               String
  bodyPreview           String
  fullBody              String?
  sentBy                String?
  outreachAttemptNumber Int? // Which outreach attempt this communication is associated with (1=initial, 2=follow-up #1, etc.)

  @@index([clientId])
  @@index([timestamp])
  @@map("communications")
}

// ============================================
// Clients - Main client records (migrated from Google Sheets)
// ============================================
model Client {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  status    String   @default("new") // ClientStatus type

  source        String  @default("manual") // "google_form" | "manual"
  formResponseId String? // Row number or unique ID from form responses
  formTimestamp  String? // Original form submission timestamp

  // Personal Info
  firstName String
  lastName  String
  email     String
  phone     String?
  age       String?

  // Payment/Insurance
  paymentType       String?
  insuranceProvider String?
  insuranceMemberId String?

  // Preferences
  preferredTimes     String? // JSON array of strings
  requestedClinician String?
  assignedClinician  String?

  // Form Data - Clinical
  presentingConcerns         String? // "What would you like to address in therapy?"
  suicideAttemptRecent       String? // "Have you attempted suicide in the past 6 months?"
  psychiatricHospitalization String? // "Have you been hospitalized..."
  additionalInfo             String? // "What else would you like to share?"

  // Evaluation
  evaluationScore        Int?
  evaluationNotes        String?
  referralReason         String?
  isDuplicate            Boolean @default(false)
  duplicateOfClientId    String?
  textEvaluationResult   String? // JSON string of TextEvaluationResult

  // Communication Tracking
  initialOutreachDate String?
  followUp1Date       String?
  followUp2Date       String?
  nextFollowUpDue     String?

  // Scheduling
  scheduledDate     String?
  simplePracticeId  String?
  paperworkComplete Boolean @default(false)

  // Referral
  referralEmailSentAt  String?
  referralClinicNames  String? // Comma-separated list of clinic names

  // Availability Tracking
  offeredAvailability  String? // JSON array of OfferedSlot objects
  acceptedSlot         String? // JSON object of AcceptedSlot (single slot client accepted)
  scheduledAppointment String? // JSON object of ScheduledAppointment (full scheduling details)

  // Closure
  closedDate         String?
  closedReason       String?
  closedFromWorkflow String? // "evaluation" | "outreach" | "referral" | "scheduling" | "other"
  closedFromStatus   String? // ClientStatus before closure

  // Relations
  outreachAttempts OutreachAttempt[]

  @@index([status])
  @@index([email])
  @@index([createdAt])
  @@index([closedFromWorkflow])
  @@map("clients")
}

// ============================================
// Booked Slots - Track which availability slots have been accepted by clients
// ============================================
model BookedSlot {
  id        String   @id @default(uuid())
  slotId    String // Matches sheet slot id (day-time normalized)
  day       String
  time      String
  clinician String // Specific clinician who was booked
  clientId  String // References Client
  bookedAt  String // ISO timestamp when client accepted
  createdAt DateTime @default(now())

  @@index([slotId])
  @@index([clientId])
  @@map("booked_slots")
}

// ============================================
// Case Reopen History - Track when closed cases are reopened
// ============================================
model CaseReopenHistory {
  id                 String   @id @default(uuid())
  clientId           String // References Client in Google Sheets
  reopenedAt         DateTime @default(now())
  reopenedBy         String // Email of user who reopened
  reopenReason       String // Required explanation
  previousStatus     String // Status before reopening
  newStatus          String // Status after reopening
  closedDate         String? // When the case was originally closed
  closedReason       String? // Original closure reason
  closedFromWorkflow String? // Which workflow the case was closed from

  @@index([clientId])
  @@index([reopenedAt])
  @@map("case_reopen_history")
}

// ============================================
// Outreach Attempts - Track individual outreach efforts per client
// ============================================
model OutreachAttempt {
  id            String    @id @default(uuid())
  clientId      String
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  attemptNumber Int // 1 = initial, 2 = follow_up_1, 3 = follow_up_2, etc.
  attemptType   String // "initial_outreach" | "follow_up_1" | "follow_up_2" | etc.
  sentAt        DateTime?
  status        String    @default("pending") // "pending" | "sent" | "skipped"
  emailSubject  String?
  emailPreview  String? // First 200 chars of email body

  // Response tracking fields for Gmail inbox scanning
  gmailThreadId      String?   // Thread ID for reply detection
  gmailMessageId     String?   // Message ID of sent email
  responseDetected   Boolean   @default(false)
  responseDetectedAt DateTime?
  responseMessageId  String?   // Message ID of the reply
  responseWindowEnd  DateTime? // When 24h response window expires

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt

  @@unique([clientId, attemptNumber])
  @@index([clientId])
  @@index([status])
  @@index([gmailThreadId])
  @@map("outreach_attempts")
}
